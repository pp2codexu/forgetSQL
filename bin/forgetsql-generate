#!/usr/bin/env python

# $Id$

## Distributed under LGPL
## (c) Stian Søiland 2002-2003
## stian@soiland.no
## http://forgetsql.sourceforge.net/

import exceptions, time, re, types, pprint, sys
# if you have not installed forgetSQL.py yet
# sys.path.append("../lib")

import forgetSQL

# change this!
import psycopg
c = psycopg.connect(database="db", user="user", password="pass")
cursor = c.cursor

try:
  True,False
except NameError:
  (True, False) = (1,0)

def generateFromTables(tables, getLinks=1, code=1):
  """Generates python code (or class objects if code==0)
     based on SQL queries on the table names given in the list
     tables."""
  curs = cursor()
  forgetters = {}   
  for table in tables:
    # Define a  mini-class
    class forgetter:
      pass
    # Register it, but capitalized name
    forgetters[table.capitalize()] = forgetter
    forgetter._sqlTable = table
    forgetter._sqlLinks = {}
    forgetter._sqlFields = {}  
    forgetter._shortView = ()
    forgetter._descriptions = {}
    forgetter._userClasses = {}

    # Get columns
    curs.execute("SELECT * FROM %s LIMIT 1" % table)
    columns = [column[0] for column in curs.description]
    # convert to dictionary and register in forgetter
    for column in columns:
      forgetter._sqlFields[column] = column
    
  if getLinks:
    # Try to find links between tables (!)  
    # Note the big O factor with this ...

    for (tableName, forgetter) in forgetters.items():
      for (key, column) in forgetter._sqlFields.items():
        # A column refering to another table would most likely
        # be called otherColumnID or just otherColumn. We'll 
        # lowercase below when performing the test.
        possTable = re.sub(r'_?id$', '', column)

        # all tables (ie. one of the forgetters) are candidates
        foundLink = False
        for candidate in forgetters.keys():
          if candidate.lower() == possTable.lower():
            if possTable.lower() == tableName.lower():
              # It's our own primary key!
              forgetter._sqlPrimary = (column,)
              break
              
            # Woooh! First - let's replace 'blapp_id' with 'blapp'
            # as the attribute name to indicate that it would
            # contain the Blapp instance, not just 
            # some ID.
            del forgetter._sqlFields[key]
            forgetter._sqlFields[possTable] = column

            # And.. we'll need to know which class we refer to
            forgetter._userClasses[possTable] = candidate
            break # we've found our candidate

  if code:
    print '''
"""Database wrappers.
Autogenerated by forgetSQL %s.
"""

import forgetSQL

class _Wrapper(forgetSQL.Forgetter):
    """Just a simple wrapper class so that you may
    easily change stuff for all forgetters. Typically
    this involves subcliassing MysqlForgetter instead."""

    # Remember to change the class function cursor() so that
    # it returns a cursor connected to the database.
    # 
    ## cursor = lambda: myDatabase.cursor()
    pass


''' % time.strftime('%Y-%m-%d')
    items = forgetters.items()
    items.sort()
    for (name, forgetter) in items:
      print "class %s(_Wrapper):" % name
      for (key, value) in forgetter.__dict__.items():
        if key.find('__') == 0:
          continue
        nice = pprint.pformat(value)
        # Get some indention
        nice = nice.replace('\n', '\n       ' + ' '*len(key))
        print '    %s = ' % key, nice
      print ""  
    print '''

# Prepare them all. We need to send in our local
# namespace.
forgetSQL.prepareClasses(locals())
'''
  else:      
    # We want the actual classes, not subclassed by this miniclass. 
    for (name, forgetter) in forgetters.items():
      # Do this magic to include both our settings
      # and the normal Forgetter stuff.
      class Spector(forgetter, Forgetter):
        """Automagically created by forgetSQL."""
        def cursor(self):
          return cursor()
      Spector.__name__ = name  
      forgetters[name] = Spector
    forgetSQL.prepareClasses(forgetters)  
    return forgetters
      
if __name__=='__main__':
    if len(sys.argv) > 1:
        file = open(sys.argv[1])
    else:
        file = sys.stdin
    tables = file.read().split()
    generateFromTables(tables)
